---
title: "Coronavirus COVID-19 (2019-nCoV) statistics in Baltic states"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: true
    fig_width: 16
    fig_height: 9
    fig_caption: true
    theme: flatly
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, error = TRUE, warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
# loading packets that are needed for running the .Rmd
source("./scripts/loading_R_packets.R")
```

```{r, include=FALSE}
# importing JHCSSE and LT data, data preparation
dir.create("./data/")
source("./scripts/data_import_preparation_word.R")
source("./scripts/data_import_preparation_word_map.R")
source("./scripts/data_import_preparation_LT.R")
```

```{r, include=FALSE}
shape <- readOGR("./shape_files/ne_50m_admin_0_sovereignty.shp",
                 encoding = "utf-8",
                 use_iconv = T,
                 verbose = FALSE,
                 stringsAsFactors = FALSE)%>%
  st_as_sf(countries)%>%
  select(SOVEREIGNT, POP_EST)%>%
  mutate(POP_EST=as.numeric(POP_EST))

```

```{r, include=FALSE}
# todo
# reikia importą zipo ir failo paėmimą iš zipo padaryt, nes dabar iš working directory ima

# INFO:
# https://www.naturalearthdata.com/downloads/50m-cultural-vectors/50m-admin-0-countries-2

# URL <- "https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/50m/cultural/ne_50m_admin_0_sovereignty.zip"
# download.file(url=URL, destfile ="./data/ne_50m_admin_0_sovereignty.zip", method = "auto")
# unzip("./data/ne_50m_admin_0_sovereignty.zip", exdir = "./data/")
# countries <- readOGR(dsn="./data/ne_50m_admin_0_sovereignty.shp",
#                              encoding = "utf-8",
#                              use_iconv = T,
#                              verbose = FALSE,
#                      stringsAsFactors = FALSE)
#  countries <- st_as_sf(countries)
#  ggplot(countries)+ geom_sf()

```



# Įvadas
Tekstas
# Duomenys
Tekstas

# Pasaulinė statistika
Tekstas

## Paplitimas pasaulyje{.tabset .tabset-fade .tabset-pills}

### Visi patvirtinti
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="confirmed",
         date==max(date))
max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))

# min(df$value,na.rm = T)
# max(df$value,na.rm = T)

my_breaks <- c(min(df$value, na.rm = T),10, 100, 1000, 10000, max(df$value, na.rm = T))

ggplot(df, aes(fill=value))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Patvirtintų apsikrėtusiųjų skaičius (duomenys ", max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")

```

### Visi patvirtinti / pop.
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="confirmed",
         date==max(date))

max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))%>%
  mutate(POP_EST=as.numeric(POP_EST))%>%
  mutate(value_pop=value/POP_EST*100000)

# summary(df$value_pop)
# min(df$value_pop,na.rm = T)
# max(df$value_pop,na.rm = T)

my_breaks <- c(0.01,0.1,1,15,300)

ggplot(df, aes(fill=value_pop))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Patvirtintų apsikrėtusiųjų skaičius tenkantis 100.000 gyventojų (duomenys ",max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")
```

### Visi aktyvūs
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="active",
         date==max(date))
max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))

# min(df$value,na.rm = T)
# max(df$value,na.rm = T)

my_breaks <- c(1, 10, 100, 1000, 10000)

ggplot(df, aes(fill=value))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Aktyvių pacientų skaičius (duomenys ", max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")

```

### Aktyvūs / pop.
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="active",
         date==max(date))

max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))%>%
  mutate(POP_EST=as.numeric(POP_EST))%>%
  mutate(value_pop=value/POP_EST*100000)

# summary(df$value_pop)
# min(df$value_pop,na.rm = T)
# max(df$value_pop,na.rm = T)

my_breaks <- c(0.01,0.1,1,15,200)

ggplot(df, aes(fill=value_pop))+
  geom_sf()+
  ylim(-55,80)+
  xlim(-130,140)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Apsikrėtusiųjų skaičius tenkantis 100.000 gyventojų (duomenys ",max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")
```

## Kita statistika {.tabset .tabset-fade .tabset-pills}
### Susirgę, pasveikę, mirę
```{r, echo=FALSE}
df <- read.csv("./data/data_world.csv",
                       stringsAsFactors = FALSE)%>%
        mutate(date=as.Date(date))%>%
        mutate(var=factor(var, levels=c("active", "recovered", "deaths")))%>%
        filter(var!="confirmed")%>%
        group_by(date, var)%>%
        summarise(value=sum(value))

max.date <- max(df$date)


ggplot(df, aes(x=date, y=value, fill=var))+
        geom_area(alpha=0.5)+
        scale_fill_manual(values=c("red", "green", "black"))+
        scale_x_date(breaks="1 week")+
        scale_y_continuous(breaks =pretty_breaks())+
        labs(title=paste0("COVID-19 (last update ", max.date,")"),
             subtitle = "Source: 2019 Novel Coronavirus COVID-19 (2019-nCoV) Data Repository by Johns Hopkins CSSE",
             x="Date",
             y="Count")+
        theme(legend.title=element_blank(),
              legend.position='bottom',
              axis.text.x = element_text(angle = 45, hjust = 1))
```



# Europos statistika
## Paplitimas europoje {.tabset .tabset-fade .tabset-pills}
### Visi patvirtinti
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="confirmed",
                CNTR_CODE %in% c("BE","BG","CZ","DK","DE","EE","IE","EL","ES","FR","HR","IT","CY","LV","LT","LU","HU","MT","NL","AT","PL","PT","RO","SI","SK","FI","SE","UK","IS","LI","NO","CH","ME","MK","AL","RS","TR","BA","XK", "RU", "BY", "UA", "MD", "MA", "DZ", "TN"),
         date==max(date),)

max.date <- max(df$date)


df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))

# min(df$value,na.rm = T)
# max(df$value,na.rm = T)

my_breaks <- c(1,10, 100, 1000, 20000)

ggplot(df, aes(fill=value))+
  geom_sf()+
  xlim(-20,38)+
  ylim(38,70)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
       geom_sf_label(aes(label =round(value,0)), size=2.5, fill="white" )+
  labs(title=paste0("Patvirtintų apsikrėtusiųjų skaičius (duomenys ", max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")

```

### Visi patvirtinti / pop.
```{r, echo=FALSE}
df <- read.csv("./data/data_world_map.csv",
               header = TRUE,
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  filter(var=="confirmed",
                CNTR_CODE %in% c("BE","BG","CZ","DK","DE","EE","IE","EL","ES","FR","HR","IT","CY","LV","LT","LU","HU","MT","NL","AT","PL","PT","RO","SI","SK","FI","SE","UK","IS","LI","NO","CH","ME","MK","AL","RS","TR","BA","XK", "RU", "BY", "UA", "MD", "MA", "DZ", "TN"),
         date==max(date),)

max.date <- max(df$date)

df <- left_join(shape, df, by=c("SOVEREIGNT"="country"))%>%
  mutate(POP_EST=as.numeric(POP_EST))%>%
  mutate(value_pop=value/POP_EST*100000)

# summary(df$value_pop)
# min(df$value_pop,na.rm = T)
# max(df$value_pop,na.rm = T)

my_breaks <- c(0.05,0.25, 1,5,25)

ggplot(df, aes(fill=value_pop))+
  geom_sf()+
  xlim(-20,38)+
  ylim(38,70)+
  scale_fill_gradientn(colours=brewer.pal(name ="YlOrRd", n=9),
                       name="Skaičius",
                       trans="log",
                       na.value = "grey100",
                       breaks=my_breaks,
                       labels=my_breaks)+
  labs(title=paste0("Patvirtintų apsikrėtusiųjų skaičius tenkantis 100.000 gyventojų (duomenys ",max.date,")"),
       subtitle = "Šaltinis: JHCSSE, skaičiavimai: corona-stat.lt")
```

## Kita statistika {.tabset .tabset-fade .tabset-pills}
### Nauji užsikrėtimai
```{r, echo=FALSE}
df <- read.csv("./data/data_world.csv",
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  mutate(var=factor(var, levels=c("active", "recovered", "deaths", "confirmed")))

df %<>%filter(valstybe%in%c("Airija","Lietuva","Austrija","Liuksemburgas",
                            "Belgija", "Malta" ,"Bulgarija","Nyderlandai",
                            "Čekija","Portugalija","Danija","Prancūzija",
                            "Estija","Rumunija","Graikija","Slovakija", 
                            "Ispanija","Slovėnija","Italija","Suomija","Kipras",
                            "Švedija","Kroatija","Vengrija","Latvija",
                            "Vokietija","Lenkija"), 
              var=="confirmed" )

max.date<-max(df$date)

df <- df %>%
  filter(date==max.date-3|date==max.date)%>%
  spread(date, value)%>%
  mutate(value=.[,5]-.[,4])%>%
  select (valstybe, value)

ggplot(df,aes(x=reorder(valstybe,value), y=value, fill=valstybe, group=valstybe)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Susirgimų skaičius", 
       title=paste0("Naujų susirgimų per paskutines 3d. skaičius ( ", max.date, " duomenimis)"),
       subtitle="Šaltinis: www.corona-stat.lt" )+
   theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```

### Naujų užsikrėtimai / pop
```{r, echo=FALSE}
df <- read.csv("./data/data_world.csv",
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  mutate(var=factor(var, levels=c("active", "recovered", "deaths", "confirmed")))

df %<>%filter(valstybe%in%c("Airija","Lietuva","Austrija","Liuksemburgas",
                            "Belgija", "Malta" ,"Bulgarija","Nyderlandai",
                            "Čekija","Portugalija","Danija","Prancūzija",
                            "Estija","Rumunija","Graikija","Slovakija", 
                            "Ispanija","Slovėnija","Italija","Suomija","Kipras",
                            "Švedija","Kroatija","Vengrija","Latvija",
                            "Vokietija","Lenkija"), 
              var=="confirmed" )

max.date<-max(df$date)

df <- df %>%
  filter(date==max.date-3|date==max.date)%>%
  spread(date, value)%>%
  mutate(value=.[,5]-.[,4])%>%
  select (valstybe, value)

pop <- get_eurostat("tps00001") %>% filter(time=="2019-01-01")%>%
        mutate(valstybe=countrycode(geo, 
                                    origin = "eurostat", 
                                    destination =  "cldr.short.lt",
                                    nomatch = NULL ))%>%
  mutate(pop=values)%>%
  select(valstybe,pop) %>%
  right_join(df, pop, by="valstybe")%>%
        mutate(value=round((value/pop*100000),1))%>%
        select(valstybe, value)

ggplot(pop,aes(x=reorder(valstybe,value), y=value)) +
        geom_bar(stat='identity',
                 fill="steelblue")+
    geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(x="Valstybė", 
       y="Susirgimų skaičius", 
       title=paste0("Naujų susirgimų skaičius 100.000 gyventojų per paskutines 3d. ( ", max.date, " duomenimis)"),
       subtitle="Šaltinis: JHCSSE Skaičiavimai: corona-stat.lt" )+
   theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))
```

### Nauji užsikrėtimai proc. pokytis
```{r, echo=FALSE}
df <- read.csv("./data/data_world.csv",
               stringsAsFactors = FALSE)%>%
  mutate(date=as.Date(date))%>%
  mutate(var=factor(var, levels=c("active", "recovered", "deaths", "confirmed")))

df %<>%filter(valstybe%in%c("Airija","Lietuva","Austrija","Liuksemburgas",
                            "Belgija", "Malta" ,"Bulgarija","Nyderlandai",
                            "Čekija","Portugalija","Danija","Prancūzija",
                            "Estija","Rumunija","Graikija","Slovakija", 
                            "Ispanija","Slovėnija","Italija","Suomija","Kipras",
                            "Švedija","Kroatija","Vengrija","Latvija",
                            "Vokietija","Lenkija"), 
              var=="confirmed" )

max.date<-max(df$date)

df <- df %>%
  filter(date==max.date-3|date==max.date)%>%
  spread(date, value)%>%
  mutate(value=round(.[,5]/.[,4]*100),0)

ggplot(df,aes(x=reorder(valstybe,value), y=value, fill=valstybe, group=valstybe)) +
  geom_bar(stat='identity',
           fill="steelblue")+
  geom_text(aes(label=value, y=value), size=3, vjust=-0.75)+
  labs(title=paste0("Naujų susirgimų per paskutines 3d. pokytis % ( ", max.date, " duomenimis)"),
       subtitle="Šaltinis: www.corona-stat.lt",
       x="Valstybė", 
       y="proc. pokytis")+
   theme(legend.title=element_blank(),
        legend.position='none',
        axis.text.x=element_text(angle=45, hjust=1))

```


# Lietuva {.tabset .tabset-fade .tabset-pills}
## Žemėlapis
```{r, echo=FALSE}
library(RColorBrewer)
df <- read.csv("./data/data_lt_county_cum.csv",
                           header = TRUE,
                           stringsAsFactors = FALSE)%>%
        mutate(date=as.Date(date))%>%
    filter(var=="confirmed",
           date==max(date))

shape <- get_eurostat_geospatial(output_class = "sf", resolution = "60", nuts_level = "3")%>%
  filter(CNTR_CODE=="LT")

df <- left_join(shape, df, by="NUTS_ID")

ggplot(df, aes(fill=values))+
  geom_sf()+
 scale_fill_gradientn(colours=rev(brewer.pal(10,"Spectral")))+
   labs(title=paste0("Suminis korona virusu apsikrėtusiųjų skaičius (duomenys ", max.date,")"),
             subtitle = "Šaltinis: corona-stat.lt")
```


# Ekonomika {.tabset .tabset-fade .tabset-pills}
## BVP
## Pramonės produkcija
## Užsienio prekyba
## Mažmeninė preyba
## Infliacija
## Kreditai
## Užimtumas / nedarbas

# Prognozės
